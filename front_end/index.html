<!DOCTYPE html>
<html lang="en-US">
  <head>
    <!-- Meta setup -->
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="keywords" content="" />
    <meta name="decription" content="" />
    <meta name="author" content="Mahmudul Hasan" />

    <!-- Title -->
    <title>Welcome</title>

    <!-- Fav Icon -->
    <link rel="icon" href="img/fav.png" />

    <!-- Include Bootstrap -->
    <link rel="stylesheet" href="css/bootstrap.min.css" />

    <!-- Main StyleSheet -->
    <link rel="stylesheet" href="css/style.css" />

    <!-- Responsive CSS -->
    <link rel="stylesheet" href="css/responsive.css" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <!--[if lte IE 9]>
      <p class="browserupgrade">
        You are using an <strong>outdated</strong> browser. Please
        <a href="https://browsehappy.com/">upgrade your browser</a> to improve
        your experience and security.
      </p>
    <![endif]-->

    <main>
      <div class="container">
        <div class="main_wrapper">
          <section id="joma">
            <div class="joma_wrapper tkpoise">
              <h2><span>টাকা</span> জমা</h2>
              <span class="bar"></span>
              <div class="taka_list"></div>
            </div>

            <div class="tktable">
              <table>
                <tr>
                  <td>মোট টাকা জমা হয়েছে -</td>
                  <td id="tkmut"></td>
                </tr>
                <tr>
                  <td>বাবু দিয়েছে -</td>
                  <td id="babutk"></td>
                </tr>
                <tr>
                  <td>মনির দিয়েছে -</td>
                  <td id="monirtk"></td>
                </tr>
              </table>
            </div>
            <div class="button">
              <button popupbutton="tk" id="tk" class="bbtn">
                নতুন টাকা জমা করুন
              </button>
            </div>
          </section>
          <section id="joma">
            <div class="joma_wrapper">
              <h2><span>চাল</span> জমা</h2>
              <span class="bar"></span>
              <div class="taka_list"></div>
            </div>

            <div class="button">
              <button popupbutton="chal" id="tk" class="bbtn">
                নতুন চাল জমা করুন
              </button>
            </div>
          </section>
          <section id="joma">
            <div class="joma_wrapper">
              <h2>মোট <span>বাজার</span></h2>
              <span class="bar"></span>
              <div class="taka_list">
                <div class="taka_item">
                  <div class="taka_item_left">
                    <p>মনির</p>
                    <span>date</span>
                  </div>
                  <div class="taka_item_right">
                    <p><span>1200</span> পট</p>
                  </div>
                </div>
                <div class="taka_item babu">
                  <div class="taka_item_left">
                    <p>বাবু</p>
                    <span>date</span>
                  </div>
                  <div class="taka_item_right">
                    <p><span>1200</span> পট</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="button">
              <button popupbutton="bazar" id="tk" class="bbtn">
                নতুন বাজার জমা করুন
              </button>
            </div>
          </section>
          <section id="joma">
            <div class="joma_wrapper">
              <h2>মোট <span>মিল</span></h2>
              <span class="bar"></span>
              <div class="taka_list">
                <div class="taka_item">
                  <div class="taka_item_left">
                    <p>মনির</p>
                    <span>date</span>
                  </div>
                  <div class="taka_item_right">
                    <p><span>1200</span> পট</p>
                  </div>
                </div>
                <div class="taka_item babu">
                  <div class="taka_item_left">
                    <p>বাবু</p>
                    <span>date</span>
                  </div>
                  <div class="taka_item_right">
                    <p><span>1200</span> পট</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="button">
              <button popupbutton="mil" id="tk" class="bbtn">
                নতুন মিল জমা করুন
              </button>
            </div>
          </section>
        </div>
      </div>
    </main>

    <div popup="tk" class="popup">
      <div class="popup_wrapper">
        <h2 class="text-center">নতুন টাকা জমা করুন</h2>
        <span closepop="tk" id="close"
          ><i class="fa-solid fa-circle-xmark"></i
        ></span>
        <div class="popup_form">
          <form id="takaForm" autocomplete="off">
            <div class="input_box_wrapper">
              <label>নাম</label>
              <select id="name" required>
                <option selected value="">নাম সিলেক্ট করুন</option>
                <option value="বাবু">বাবু</option>
                <option value="মনির">মনির</option>
              </select>
            </div>
            <div class="input_box_wrapper">
              <label>টাকার পরিমান</label>
              <input
                id="amount"
                required
                placeholder="টাকার পরিমান"
                type="number"
              />
            </div>
            <div class="input_box_wrapper">
              <label>তারিখ</label>
              <input id="date" required type="date" />
            </div>
            <div class="submitBtn">
              <button class="bbtn" type="submit">সাবমিট করুন</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div popup="chal" class="popup">
      <div class="popup_wrapper">
        <h2 class="text-center">নতুন টাকা জমা করুন</h2>
        <span closepop="chal" id="close"
          ><i class="fa-solid fa-circle-xmark"></i
        ></span>
        <div class="popup_form">
          <form autocomplete="off" action="">
            <div class="input_box_wrapper">
              <label>নাম</label>
              <select required>
                <option selected value="">নাম সিলেক্ট করুন</option>
                <option value="বাবু">বাবু</option>
                <option value="মনির">মনির</option>
              </select>
            </div>
            <div class="input_box_wrapper">
              <label>চালের পরিমান</label>
              <input required placeholder="চালের পরিমান" type="number" />
            </div>
            <div class="input_box_wrapper">
              <label>তারিখ</label>
              <input required type="date" />
            </div>
            <div class="submitBtn">
              <button class="bbtn" type="submit">সাবমিট করুন</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div popup="bazar" class="popup">
      <div class="popup_wrapper">
        <h2 class="text-center">নতুন টাকা জমা করুন</h2>
        <span closepop="bazar" id="close"
          ><i class="fa-solid fa-circle-xmark"></i
        ></span>
        <div class="popup_form">
          <form autocomplete="off" action="">
            <div class="input_box_wrapper">
              <label>নাম</label>
              <select required>
                <option selected value="">নাম সিলেক্ট করুন</option>
                <option value="বাবু">বাবু</option>
                <option value="মনির">মনির</option>
              </select>
            </div>
            <div class="input_box_wrapper">
              <label>বাজার এর টাকার পরিমান</label>
              <input
                required
                placeholder="বাজার এর টাকার পরিমান"
                type="number"
              />
            </div>
            <div class="input_box_wrapper">
              <label>তারিখ</label>
              <input required type="date" />
            </div>
            <div class="submitBtn">
              <button class="bbtn" type="submit">সাবমিট করুন</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div popup="mil" class="popup">
      <div class="popup_wrapper">
        <h2 class="text-center">নতুন টাকা জমা করুন</h2>
        <span closepop="mil" id="close"
          ><i class="fa-solid fa-circle-xmark"></i
        ></span>
        <div class="popup_form">
          <form autocomplete="off" action="">
            <div class="input_box_wrapper">
              <label>নাম</label>
              <select required>
                <option selected value="">নাম সিলেক্ট করুন</option>
                <option value="বাবু">বাবু</option>
                <option value="মনির">মনির</option>
              </select>
            </div>
            <div class="input_box_wrapper">
              <label>মিল সংখ্যা</label>
              <input required placeholder="মিল সংখ্যা" type="number" />
            </div>
            <div class="input_box_wrapper">
              <label>তারিখ</label>
              <input required type="date" />
            </div>
            <div class="submitBtn">
              <button class="bbtn" type="submit">সাবমিট করুন</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Main jQuery -->
    <script src="js/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap Js -->
    <script src="js/bootstrap.bundle.min.js"></script>

    <!-- Fontawesome Script -->
    <script src="https://kit.fontawesome.com/e7f2043049.js"></script>

    <!-- Custom jQuery -->
    <script src="js/app.js"></script>

    <!-- Scroll-Top button -->
    <a href="#" class="scrolltotop"><i class="fas fa-angle-up"></i></a>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Handle form submission (Add to 'Taka' collection)
        document
          .getElementById("takaForm")
          .addEventListener("submit", async function (event) {
            event.preventDefault();
            const name = document.getElementById("name").value;
            const amount = document.getElementById("amount").value;
            const date = document.getElementById("date").value;

            const formData = {
              name,
              amount,
              date,
            };

            try {
              const response = await fetch(
                "http://localhost:3000/api/add-to-taka",
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(formData),
                }
              );

              const result = await response.json();

              if (response.ok) {
                // Show SweetAlert on successful form submission
                Swal.fire({
                  icon: "success",
                  title: "Success!",
                  text: "Data has been added to the Taka collection.",
                  showConfirmButton: false,
                  timer: 1500,
                });

                // After successful submission, fetch the updated list of data and display it
                fetchTakaData();
              } else {
                // Show SweetAlert for error response
                Swal.fire({
                  icon: "error",
                  title: "Oops...",
                  text:
                    result.error || "Something went wrong. Please try again.",
                });
              }
            } catch (error) {
              console.error("Error submitting form:", error);
              // Show SweetAlert on fetch error
              Swal.fire({
                icon: "error",
                title: "Network Error",
                text: "Failed to submit the form. Please try again later.",
              });
            }
          });

        // Fetch data from the 'Taka' collection and display it
        async function fetchTakaData() {
          try {
            const response = await fetch("http://localhost:3000/api/get-taka");
            const data = await response.json();

            const takaList = document.querySelector(".taka_list");
            takaList.innerHTML = ""; // Clear previous data

            // Initialize variables to store the total amounts for each name
            let totalAmountBabu = 0;
            let totalAmountMonir = 0;
            let totalAmountOthers = 0;

            data.forEach((item) => {
              // Sum the amounts based on the item name
              totalAmountOthers += parseInt(item.amount);
              if (item.name === "বাবু") {
                totalAmountBabu += parseInt(item.amount); // Add to বাবু's total
              } else if (item.name === "মনির") {
                totalAmountMonir += parseInt(item.amount); // Add to মনির's total
              }

              const nameClass =
                item.name === "বাবু"
                  ? "babu"
                  : item.name === "মনির"
                  ? "monir"
                  : "taka_item";

              takaList.innerHTML += `<div class="item_wrapper" data-id="${item._id}">
                <div class=${nameClass}>
                  <div class="taka_item_left">
                    <p>${item.name}</p>
                    <span>${item.date}</span>
                  </div>
                  <div class="taka_item_right">
                    <p><span>${item.amount}</span> টাকা</p>
                  </div>
                </div>
                <div class="delete_item">
                  <p><i class="fa-solid fa-trash"></i> ডিলিট করুন</p>
                </div>
              </div>`;
            });

            // Display the total amounts for each category
            document.querySelector(
              "#babutk"
            ).textContent = `${totalAmountBabu} টাকা`; // Display বাবু's total
            document.querySelector(
              "#monirtk"
            ).textContent = `${totalAmountMonir} টাকা`; // Display মনির's total
            document.querySelector(
              "#tkmut"
            ).textContent = `${totalAmountOthers} টাকা`; // Display others' total (optional)
          } catch (error) {
            console.error("Error fetching data:", error);
          }
        }

        // Handle delete button click using event delegation
        document
          .querySelector(".taka_list")
          .addEventListener("click", async (event) => {
            if (event.target.closest(".delete_item")) {
              const itemId = event.target
                .closest(".item_wrapper")
                .getAttribute("data-id");

              // Call the delete API
              try {
                const response = await fetch(
                  `http://localhost:3000/api/delete-taka/${itemId}`,
                  {
                    method: "DELETE",
                  }
                );

                if (response.ok) {
                  // Show SweetAlert on successful deletion
                  Swal.fire({
                    icon: "success",
                    title: "Deleted!",
                    text: "Item has been removed from the Taka collection.",
                    showConfirmButton: false,
                    timer: 1500,
                  });

                  // After successful deletion, fetch the updated list of data and display it
                  fetchTakaData();
                } else {
                  Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "Failed to delete the item. Please try again.",
                  });
                }
              } catch (error) {
                console.error("Error deleting item:", error);
                Swal.fire({
                  icon: "error",
                  title: "Network Error",
                  text: "Failed to delete the item. Please try again later.",
                });
              }
            }
          });

        // Initial data load
        fetchTakaData();
      });
    </script>
  </body>
</html>
